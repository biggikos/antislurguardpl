# AntiSlurGuard

AntiSlurGuard — плагин для Paper и его форков версии апи 1.21 (Java 21), который незаметно блокирует никнеймы и сообщения игроков, нарушающие внешние правила по типу «hateful slurs». Проверки выполняются до входа игрока и при отправке сообщения, при этом обычная нецензурная лексика не затрагивается.

## Возможности

- Нормализация входных строк (регистрозависимость, диакритика, «leet»-замены, латинизация кириллицы через ICU4J, удаление не букв/цифр и схлопывание повторов) перед проверкой.
- Автоматические вариации для простых слов из `banned-patterns.txt`: даже если в файле записан «чистый» шаблон, фильтр реагирует на десятки модификаций с заменами символов, диакритикой и повторениями.
- Приоритетные исключения: отдельный файл `exceptions.txt` и команда `/asg except add/remove` позволяют добавить фразы, которые никогда не должны блокироваться (перебивают автогенерируемые вариации).
- Тихие наказания: блокировка входа, кик, бан, временный бан или выполнение команды (включая шаблоны команд EssentialsX). Игрокам ничего не сообщается, кроме опционального личного уведомления.
- Иммунитет для админов по пермишену `antislurguard.bypass`.
- Агрегированная статистика блокировок выводится в консоль только при «массовых» нарушениях (порог настраивается).
- Персональные уведомления админов о нарушениях в чате, которые можно включать/выключать для каждого оператора. Выбор сохраняется в отдельном файле и не сбрасывается при перезагрузке.
- Учёт нарушений каждого игрока в отдельном файле. После заданного количества попыток отправить запрещённое сообщение автоматически выдаётся перманентный бан.
- Отдельные логи в `userdata/` с полными исходными сообщениями, которые были заблокированы (для нормальной модерации и разбора контекста).
- Анти-спам с персональным slowmode: если игрок повторяет сообщения, ему автоматически включается «медленный режим» с настраиваемым кулдауном между репликами, а админы получают алерт (если не отключили уведомления).
- Команда `/asg` с подкомандами перезагрузки, статистики, тестирования (с выводом конкретного совпавшего паттерна), редактирования списка бан-слов и исключений, управления уведомлениями и игроками (размутить, разбанить, снять slowmode) и автоматическими подсказками TAB.
- Гибкая локализация: язык комментариев и сообщений выбирается через `lang` (английский по умолчанию, в комплекте есть `ru_RU`). Для каждого языка создаётся редактируемая копия в `plugins/AntiSlurGuard/lang/`.
- Автоматическая рассылка сообщений (анонсы) с поддержкой кликабельных ссылок; контент берётся из отдельного файла и отправляется всем игрокам по расписанию.

## Настройка

- `plugins/AntiSlurGuard/config.yml` — основные параметры (пути, язык, опции нормализации, наказания, логирование, уведомления, интеграция с EssentialsX, рассылки, инструменты управления). Комментарии автоматически переводятся в зависимости от `lang`.
- `plugins/AntiSlurGuard/messages.yml` — все редактируемые сообщения и шаблоны уведомлений (цветовые коды `&`).
- `plugins/AntiSlurGuard/banned-patterns.txt` — внешний список паттернов (одно слово/regex на строку, `#` и пустые строки игнорируются). Простые слова автоматически получают вариации.
- `plugins/AntiSlurGuard/exceptions.txt` — список исключений (слово/regex на строку), которые не должны блокироваться, даже если совпадают с автогенерацией.
- `plugins/AntiSlurGuard/admin-notify.yml` — персональные настройки уведомлений админов (создаётся автоматически, редактировать не требуется).
- `plugins/AntiSlurGuard/player-stats.yml` — журнал нарушителей (обновляется плагином).
- `plugins/AntiSlurGuard/userdata/` — отдельные файлы с оригинальными текстами заблокированных сообщений для каждого игрока.
- `plugins/AntiSlurGuard/runtime-settings.yml` — необязательные ручные оверрайды длительностей наказаний (при удалении будут использованы значения из `config.yml`).
- `plugins/AntiSlurGuard/announcements.yml` — список рассылок, каждая запись содержит текст, интервал, hover-подсказку и кликабельную ссылку.
- `plugins/AntiSlurGuard/lang/` — копии встроенных языковых файлов (`en_US.yml`, `ru_RU.yml`), которые можно править без пересборки плагина.

### Ключевые секции config.yml

- `lang` — код языка для комментариев/шаблонов (`en_US` или `ru_RU`).
- `paths` — расположение всех файлов (`patternsFile`, `exceptionsFile`, `messagesFile`, `adminNotifyFile`, `playerStatsFile`, `userDataDir`, `runtimeSettingsFile`, `announcementsFile`, `languagesDir`).
- `patterns.autoVariants` — генерация вариаций для простых слов.
- `normalize` — стадийность обработки текста (регистронезависимость, NFD + удаление диакритики, «leet»-замены, латинизация, удаление всего кроме букв/цифр, схлопывание повторов). По умолчанию выключено — включайте вручную, если нужна агрессивная очистка.
- `console` — интервал агрегирования и порог «массового» алерта в консоль.
- `notifications.player` — включение приватного сообщения нарушителю и ключ сообщения из `messages.yml`.
- `notifications.admin` — включение алертов для админов и ключ сообщения для событий в чате.
- `antiSpam` — анти-спам фильтр и slowmode: окно поиска повторов, порог срабатывания, длительность и кулдаун, а также ключи сообщений для игроков и админов.
- `punishments.nickname` / `punishments.chat` — действия `DISALLOW`, `KICK`, `BAN`, `TEMPBAN`, `COMMAND` или `NONE`. Для `COMMAND` доступны плейсхолдеры `{player}`, `{match}`, `{type}`, `{reason}`, `{durationSeconds}`.
- `stats` — учёт нарушений в `player-stats.yml` и порог автопермабана.
- `essentials` — шаблоны команд (c плейсхолдерами `{player}`, `{reason}`, `{durationSeconds}`, `{match}`, `{type}`) для интеграции с EssentialsX.
- `announcements` — глобальные настройки рассылки (включение и значение по умолчанию). Сами сообщения лежат в `announcements.yml`.
- `management` — команды, которые выполняются при использовании `/asg unmute` и `/asg unban`.

### Уведомления

Тексты берутся из `messages.yml`, а включение — из секции `notifications`:

- `notifications.player` — отправка приватного сообщения нарушителю при блокировке чата.
- `notifications.admin` — оповещения админов о нарушениях в чате. Любой оператор может отключить/включить уведомления для себя или коллег командой `/asg notify`, выбор сохраняется в `admin-notify.yml`.

## Команда администратора

`/asg <help|reload|stats [player]|test <text>|add <pattern>|remove <pattern>|except <add|remove> <text>|notify <player|me> <on|off|toggle>|logs <player>|unmute <player>|unban <player>|slowmode <player> clear>`

- `help` — выводит список всех подкоманд с кратким описанием прямо в игре и доступен как подсказка по TAB.
- `reload` — перечитать `config.yml`, `messages.yml`, `banned-patterns.txt` и вспомогательные файлы.
- `stats` — без аргументов показывает текущие счётчики блокировок; с ником или UUID выдаёт данные конкретного игрока из `player-stats.yml`.
- `test <text>` — выводит нормализованный вид строки, совпавший паттерн из файла и что именно сработало.
- `add <pattern>` — добавляет новое слово/regex в файл паттернов прямо из игры (сразу начинает работать).
- `remove <pattern>` — удаляет существующий шаблон из файла паттернов.
- `except <add|remove> <text>` — добавляет или удаляет исключение в отдельном файле, чтобы выбранная фраза больше не блокировалась.
- `notify toggle` — переключает собственные уведомления администратора.
- `notify <ник> <on|off|toggle>` — изменяет настройки уведомлений другого администратора (например, для стримера).
- `logs <ник>` — выгружает историю нарушений из `userdata/<ник>.log` с оригинальными сообщениями и временем отправки.
- `unmute <ник>` / `unban <ник>` — запускают команды из секции `management` для быстрой помощи игроку.
- `slowmode <ник> clear` — снимает персональный slowmode (например, если нарушитель уже исправился).

Для доступа к команде требуется пермишен `antislurguard.admin` (по умолчанию у операторов).

## Файл паттернов

`plugins/AntiSlurGuard/banned-patterns.txt` создаётся автоматически, если отсутствует. Добавляйте по одному слову или regex на строку. Пустые строки и строки, начинающиеся с `#`, игнорируются. Паттерны компилируются с флагами `CASE_INSENSITIVE | UNICODE_CASE`, а простые слова автоматически превращаются во множество вариаций (замены символов, удаление шумов и т.д.).

## Статистика

Плагин проверяет накопленные блокировки раз в `console.aggregateIntervalSeconds` секунд и выводит строку вида `[AntiSlurGuard] Заблокировано X ник(ов) и Y сообщ.(ий) по regex` только если количество нарушений за интервал превысило `console.massAlertThreshold`. После проверки счётчики обнуляются.

`player-stats.yml` ведёт учёт нарушений в чате и перманентных банов. Порог автопермабана задаётся в `stats.autoPermaBanThreshold`. Когда лимит достигается, плагин автоматически применяет BAN с причиной из `messages.yml`.
